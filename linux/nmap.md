nmap
===

目标说明
---

nmap 支持 CIDR 风格的地址。可以附加一个 `/<numbit>` 在一个IP地址或主机名后面，Nmap将会扫描所有和该参考IP地址具有 numbit 相同比特的所有IP地址或主机。还可以使用`-`， `,` 来表示范围，如 10.10.1-254.1,3。

除了在命令行中指定目标外，还可以使用如下选项来控制目标的选择：

- -iL <inputfilename>  
  从inputfilename中读取目标说明。  
- -iR <hostnum>  
  随机选择目标。在互联网范围内随机选择 hostnum 个IP。不合需要的IP如特定的私有，组播，或未分配的地址将自动略过。
- --exclude <host1[, host2][, host3], ...>  
  排除主机/网络。
- --excludefile <excludefile>  
  排除文件中的列表。


主机发现
---

在许多网络上，在给定的时间里，往往只有少部分的IP地址是活动的，主机发现能够找到零星分布的活动IP。  

如果没有指定主机发现的选项，Nmap默认进行Ping扫描（-sP）。一个例外是ARP扫描用于局域网上的任何目标机器。

下列选项控制主机发现：

- -sL （列表扫描）  
 仅仅列出网络上的和每台主机，不发送任何报文到目标机器。当仅使用列表扫描时，像其它一些高级功能如端口扫描，ping扫描就没有了。

- -sP （Ping扫描）  
 仅进行Ping扫描，然后打印对扫描做出响应的主机。该选项可以很方便得出网络上有多少机器正在运行。`-sP`选项在默认情况下，会发送一个TCP ack报文到80端口和一个ICMP回声请求到每台目标机器。

- -P0 （无ping）  
 该选项完全跳过Nmap发现阶段。默认情况下 Nmap 只对正在运行的主机进行高强度的探测，使用`-P0`后，就好像指定的目标IP都是运行的并对其进行所要求的扫描。

- -PS [portlist]   
 该选项发送一个设置了SYN标志位的空TCP报文。


端口扫描
---

端口扫描有如下选项：  

- -sS （TCP SYN）  
 SYN扫描是默认的扫描方式，其执行速度很快。SYN扫描也被称为半开放扫描，因为它从来不完成一个完整的TCP连接，它发送一个SYN报文，就像真的打开一个连接，然后等待响应。SYN/ACK 表示端口在监听， RST 表示没有监听。如果数次重发后仍没有响应，该端口标记为被过滤。

- -sT （TCP connect()扫描）  
 当SYN扫描不能使用时， TCP connect扫描就是默认的TCP扫描。Nmap通过创建 connect系统调用 去和目标机及端口建立连接，相较SYN扫描，这显然会花费更多时间，而且目标机的IDS(入侵检测系统)可以捕获两者，虽然大部分机器不会有这样的报警系统。当nmap进行连接，不发送数据，关闭连接这一系列动作时，目标机的syslog会记录这些信息。

- -sU （UDP扫描）  

扫描UDP服务。如DNS, NTP, DHCP, SNMP （端口号分别为53, 123, 161/162, 67/68）这些服务。 `-sU`可以和TCP扫描和SYN扫描结合起来。

UDP扫描的问题是扫描时间长，开放的和被过滤的端口很少响应，让nmap超时然后再探测。关闭的端口有更大的问题，它们一般发回一个ICMP端口无法到达的错误（关闭的TCP端口响应SYN报文给SYN扫描或RST报文给TCP connect扫描），而Linux内核限制一秒钟只能发送一条目标不可到达消息，因此扫描端口可以会花很长时间。


- -sA （TCP ACK扫描） 和 -sW （TCP窗口扫描）  

根据扫描返回的RST报文中相应字段来判断端口的状态。

- --scanflags （定制的TCP扫描）  
`--scanflags`选项允许指定任意TCP标志来设计扫描，以躲过那些仅通过手册添加规则的入侵检测系统。

- -sI <zombie host[:probeport]>(Idlescan)  
这种扫描方法利用zombie主机上已知的IP分段ID序列生成算法来判断目标机上开放端口信息。该方法不会从真实IP地址向目标机发送任何报文。更深入讨论可以参考 [TCP Idle Scan (-sI)](http://nmap.org/book/idlescan.html).


端口说明和扫描顺序：

- -p <port ranges> （只扫描指定的端口）  
默认情况下只会扫描1-1024端口及nmap-services文件列出的高级端口。单个端口和连字符可以表示端口范围，范围的开始值和/或结尾值可以被省略，分别导致Nmap使用1和65535， 如使用`-p -` 从端口1扫描到65535。

- -F （快速的扫描）
扫描nmap-services中的端口。

- -r （顺序扫描端口）  
默认情况下nmap会按随机顺序扫描端口（效率高），但可以指定`-r`来按顺序扫描端口。

服务和版本探测
---

部分参数如下：

- -sV   
  打开版本探测

- -O
  探测操作系统和服务版本
  
- -A  
  探测操作系统和服务版本


时间和性能
---

当扫描大量机器或指定一些特定的扫描选项时会增加扫描时间，这时可能需要在参数上进行一些优化。


Reference
---

- [Nmap参考指南](http://nmap.org/man/zh/index.html)














