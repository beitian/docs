## 磁盘

### 结构
[Disk structure](http://dysphoria.net/OperatingSystems1/6_physical_disk.html) 中粗略的讲了下磁盘的大致构成：

![physical disk structure](http://dysphoria.net/OperatingSystems1/images/physical-disk.gif)

现代磁盘有些复杂，一般讨论时都会做简化：磁盘由一个或多个同轴旋转的盘片组成，盘片分为双面盘片和单面盘片，每个盘面(surface)有一个磁头进行读写。盘面在格式化的时候形成若干个同心圆形式的磁道(track)，每个磁盘又被平分为多个扇区(sector)，所有盘面上同一位置的磁道组成柱面(Cylinder)。

盘面从上到下从 0 开始编号，由于每个盘面对应一个碰头，所以盘面号也称为碰头号。磁道从外往内从 0 开始编号，由于磁道构成柱面，所以磁道号也即柱面号。扇区在磁道中的位置即扇区号，每个扇区包括 512/1024 个字节，扇区又被称为“块”，块是磁盘存储器的基本单位，即在读写数据时，至少从磁盘上读写一个块的内容。块由磁头号、柱面号和扇区号决定。

### 磁盘 I/O 时间
显然:
```
数据访问时间 = 寻道时间 + 旋转时间 + 磁头读写时间
```

而磁头读写时间基本是固定的且耗时很少，一般不做讨论。

旋转时间取决于磁盘旋转速度，一般也较小。由于旋转方向是固定的，所以对于旋转时间的优化也较简单，即寻找最短距离：当多个请求访问同一柱面的不同扇区时，不是按请求的先后顺序，而是按扇区号的顺序返回响应。这样可以在旋转一周内完成各个请求。另外还有一个问题，每次读写一个扇区的内容时，还需要花一定时间对数据进行处理，而磁盘仍在旋转，当需要再次读写时，有可能已经转过去几个扇区了，如果扇区按顺序编号，此时需要再次旋转一圈才能到指定位置。所以一般操作系统会对扇区进行交叉编号，如顺序编号为：1，2，3，4，5，6，7，8，9，10，11，12。若交叉因子为 2:1，则交叉编号为：1，7，2，8，3，9，4，10，5，11，6，12；若交叉因子为 3:1，则交叉编号为：1，5，9，2，6，10，3，7，11，4，8，12。少部分操作系统采取“按道缓存”的方法，即一次读写一个磁道的信息。

磁盘读写的 I/O 时间主要取决于寻道时间，磁盘调度算法用于优化平均响应时间。以下介绍几种磁盘调度算法。

### 磁盘调度算法

这里举一个相对具体的例子来分析各种磁盘调度算法：现在有几个请求，其需要访问数据依次在于在 95, 180, 34, 119, 11, 123, 62, 64 等磁道，请求初始磁道为 50，终止磁道为 199。对于这样的需求，如下分别分析。

#### First Come-First Serve
简称 FCFS，即按请求先后顺序先来先服务，这是一种最简单的调度算法。如果只有少量请求且请求数据大多聚焦在一起，这种算法能有很好的性能，不过一般而言，请求量大或数据较分散的话，这片算法类似于随机算法了。

针对需求，其寻道过程如下：

![fcfs](http://www.cs.iit.edu/~cs561/cs450/disksched/fcfs.bmp)

可以看到，当数据较随机时，磁头需要来回不断的移动。FCFS 的优点是公平简单，不会有饥饿的情况，缺点是效率不高。

#### Shortest Seek Time First 
简称 SSTF，即最短寻找时间优先算法，其每次磁头每次处理的都是离当前磁道最近的磁道。如读取 50 号磁道的数据后，由于 62 离其最近，因此接下来处理 62 号磁道数据，而非 95，接下来的请求依此类推。如下图：

![sstf](http://www.cs.iit.edu/~cs561/cs450/disksched/sstf.bmp)

虽然这种算法磁头移动很少，但有较大可能会产生饥饿的情况，当大量请求的数据都聚集在一块时，对于请求读取远离这块磁道的数据而言，将会一直处于饥饿状态。因此这种算法一般也不常用。

#### SCAN(or Elevator)
扫描算法，又称电梯算法。其在磁头当前移动方向上选择与当前处理磁道最近的磁道做为下一次处理的对象。如在磁头移动方向上，34 号磁道离其最近，接下来是 11 号磁道，到头后，磁头反向扫描最近的磁道，直到处理完这个方向上的所有请求，再次反向扫描，周而复始。如下图：

![scan](http://www.cs.iit.edu/~cs561/cs450/disksched/scan.bmp)

电梯算法同时兼顾的磁道间距离和磁头移动方向，因此能有不错的性能，但对于刚扫描过的磁道，如果接下来还有请求落在其上，只能等待下次磁头扫描回来才能读取，此时造成这部分请求饥饿。

#### LOOK
类似 SCAN，不过当磁头移动方向没有需要访问的磁道后，磁头即反向扫描。

#### Circular Scan
简称 C-SCAN，与 SCAN 唯一不同的是，当同一方向磁道扫描完成后，磁头并不反向，而是跳到磁道开头重新朝同一方向扫描，如下：

![c-scan](http://www.cs.iit.edu/~cs561/cs450/disksched/c-scan.bmp)

#### C-LOOK
组合 LOOK 算法与 C-SCAN 算法，当磁头扫描方向没需要处理的磁道时即跳到磁道开头重新朝同一方向扫描，如下：

![c-look](http://www.cs.iit.edu/~cs561/cs450/disksched/c-look.bmp)

### 检测坏磁盘
磁盘检测可以通过 Megacli 或定期查看 dmesg 等来做，对于检查只读情况，也可以查看 `/proc/mount` 状态。以下是检查 dmesg 时发现的部分常见问题。

- EXT4-fs error      
这类问题是文件系统故障，修复或重新格式化文件系统即可。

__TODO__

### 参考
- [Disk structure](http://dysphoria.net/OperatingSystems1/6_physical_disk.html)
- [Disk Scheduling Algorithms](http://www.cs.iit.edu/~cs561/cs450/disksched/disksched.html)
